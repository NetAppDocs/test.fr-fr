---
sidebar: sidebar 
permalink: task_config_telegraf_agent.html 
keywords: telegraf, installation, install, agent, telegraf agent 
summary: 'Cloud Insights prend en charge Telegraf en tant qu"agent pour collecter des données d"intégration. Il peut être configuré sur Windows, Linux, MacOS et Kubernetes.' 
---
= Configuration d'un agent pour collecter des données
:allow-uri-read: 


[role="lead"]
Utilisations de Cloud Insights link:https://docs.influxdata.com/telegraf/v1.19/["Télégraf"] en tant qu'agent pour la collecte de données d'intégration. Telegraf est un agent serveur piloté par plug-in qui peut être utilisé pour collecter et signaler des mesures, des événements et des journaux. Les plug-ins d'entrée sont utilisés pour recueillir les informations souhaitées dans l'agent en accédant directement au système/système d'exploitation, en appelant des API tierces ou en écoutant des flux configurés (c.-à-d. Kafka, statsD, etc.). Les plug-ins de sortie sont utilisés pour envoyer les mesures, les événements et les journaux collectés depuis l'agent vers Cloud Insights.

La version actuelle de Telegraf pour Cloud Insights est *1.19.3*.


NOTE: Pour un audit et un reporting précis des données, il est fortement recommandé de synchroniser l'heure sur l'ordinateur Agent à l'aide de *NTP (Network Time Protocol)* ou *SNTP (simple Network Time Protocol)*.


NOTE: Si vous souhaitez vérifier les fichiers d'installation avant d'installer l'agent, reportez-vous à la section ci-dessous <<Vérification des sommes de contrôle>>.



== Installation d'un agent

Si vous installez un collecteur de données de service et que vous n'avez pas encore configuré un agent, vous êtes invité à installer un agent pour le système d'exploitation approprié. Cette rubrique fournit des instructions pour l'installation de l'agent Telegraf sur les systèmes d'exploitation suivants :

* <<Répertoires de base>>
* <<RHEL et CentOS>>
* <<Ubuntu et Debian>>
* <<Mac OS>>
* <<Kubernetes>>


Pour installer un agent, quelle que soit la plate-forme que vous utilisez, vous devez d'abord effectuer les opérations suivantes :

. Connectez-vous à l'hôte que vous utiliserez pour votre agent.
. Connectez-vous à votre site Cloud Insights et accédez à *Admin > Data Collectors*.
. Cliquez sur *+Data Collector* et choisissez un collecteur de données à installer.


. Choisir la plate-forme la mieux adaptée à votre hôte (Windows, Linux, MacOS, etc.)
. Suivez les étapes restantes pour chaque plate-forme.



NOTE: Une fois que vous avez installé un agent sur un hôte, vous n'avez pas besoin d'installer de nouveau un agent sur cet hôte.


TIP: Une fois que vous avez installé un agent sur un serveur/VM, Cloud Insights collecte les metrics de ce système en plus de la collecte à partir de tous les collecteurs de données que vous configurez. Ces metrics sont rassemblés sous la forme link:task_config_telegraf_node.html["Metrics de nœud"].


NOTE: Si vous utilisez un proxy, lisez les instructions du proxy de votre plate-forme avant d'installer l'agent Telegraf.



=== Répertoires de base

image:AgentInstallWindows.png["Installation de Windows Agent"]

.Conditions préalables :
* PowerShell doit être installé
* Si vous êtes derrière un proxy, suivez les instructions de la section *Configuration du support proxy pour Windows*.


.Procédure d'installation de l'agent sous Windows :
. Choisissez une clé d'accès d'agent.
. Copiez le bloc de commande à partir de la boîte de dialogue d'installation de l'agent. Vous pouvez cliquer sur l'icône du presse-papiers pour copier rapidement la commande dans le presse-papiers.
. Ouvrez une fenêtre PowerShell
. Collez la commande dans la fenêtre PowerShell, puis appuyez sur entrée.
. La commande télécharge le programme d'installation de l'agent approprié, l'installe et définit une configuration par défaut. Une fois l'opération terminée, le service agent redémarre. La commande a une clé unique et est valide pendant 24 heures.
. Cliquez sur *Terminer* ou *Continuer*


Une fois l'agent installé, vous pouvez utiliser les commandes suivantes pour démarrer/arrêter le service :

....
Start-Service telegraf
Stop-Service telegraf
....


==== Configuration du support de proxy pour Windows


NOTE: Les étapes ci-dessous présentent les actions nécessaires pour définir les variables d'environnement _http_proxy/https_proxy_. Pour certains environnements proxy, les utilisateurs peuvent également avoir besoin de définir la variable _no_proxy Environment_.

Pour les systèmes résidant derrière un proxy, procédez comme suit pour définir la ou les variables d'environnement _https_proxy_ et/ou _http_proxy_ *ANTÉRIEURES* à l'installation de l'agent Telegraf :

 [System.Environment]::SetEnvironmentVariable(“https_proxy”, “<proxy_server>:<proxy_port>”, [System.EnvironmentVariableTarget]::Machine)


==== Désinstallation de l'agent

Pour désinstaller l'agent sous Windows, procédez comme suit dans une fenêtre PowerShell :

. Arrêtez et supprimez le service Telegraf :
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. Retirez le certificat du magasin de la vérité :
+
....
cd Cert:\CurrentUser\Root
rm E5FB7B68C08B1CA902708584C274F8EFC7BE8ABC
....
. Supprimez le dossier _C:\Program Files\telegraf_ pour supprimer le fichier binaire, les journaux et les fichiers de configuration
. Supprimez la clé _SYSTÈME\CurrentControlSet\Services\EventLog\application\telegraf_ du Registre




==== Mise à niveau de l'agent

Pour mettre à niveau l'agent telegraf, procédez comme suit :

. Arrêtez et supprimez le service telegraf :
+
....
Stop-Service telegraf
sc.exe delete telegraf
....
. Supprimez la clé _SYSTÈME\CurrentControlSet\Services\EventLog\application\telegraf_ du Registre
. Supprimer _C:\Program Files\telegraf\telegraf.conf_
. Supprimer _C:\Program Files\telegraf\telegraf.exe_
. link:#windows["Installez le nouvel agent"].




=== RHEL et CentOS

image:Agent_Requirements_Rhel.png["Installation de l'agent RHEL/CentOS"]

.Conditions préalables :
* Les commandes suivantes doivent être disponibles : curl, sudo, ping, sha256sum, openssl, et dmidecode
* Si vous êtes derrière un proxy, suivez les instructions de la section *Configuration du support proxy pour RHEL/CentOS*.


.Étapes d'installation de l'agent sur RHEL/CentOS :
. Choisissez une clé d'accès d'agent.
. Copiez le bloc de commande à partir de la boîte de dialogue d'installation de l'agent. Vous pouvez cliquer sur l'icône du presse-papiers pour copier rapidement la commande dans le presse-papiers.
. Ouvrez une fenêtre de jeu
. Collez la commande dans la fenêtre Bash et appuyez sur entrée.
. La commande télécharge le programme d'installation de l'agent approprié, l'installe et définit une configuration par défaut. Une fois l'opération terminée, le service agent redémarre. La commande a une clé unique et est valide pendant 24 heures.
. Cliquez sur *Terminer* ou *Continuer*


Une fois l'agent installé, vous pouvez utiliser les commandes suivantes pour démarrer/arrêter le service :

Si votre système d'exploitation utilise le système (CentOS 7+ et RHEL 7+) :

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
Si votre système d'exploitation n'utilise pas le système (CentOS 7+ et RHEL 7+) :

....
sudo service telegraf start
sudo service telegraf stop
....


==== Configuration de la prise en charge de Proxy pour RHEL/CentOS


NOTE: Les étapes ci-dessous présentent les actions nécessaires pour définir les variables d'environnement _http_proxy/https_proxy_. Pour certains environnements proxy, les utilisateurs peuvent également avoir besoin de définir la variable _no_proxy Environment_.

Pour les systèmes résidant derrière un proxy, effectuez les opérations suivantes *ANTÉRIEUR* à l'installation de l'agent Telegraf :

. Définissez les variables d'environnement _https_proxy_ et/ou _http_proxy_ pour l'utilisateur actuel :
+
 export https_proxy=<proxy_server>:<proxy_port>
. Créez _/etc/default/telegraf_ et insérez des définitions pour les variables _https_proxy_ et/ou _http_proxy_ :
+
 https_proxy=<proxy_server>:<proxy_port>




==== Désinstallation de l'agent

Pour désinstaller l'agent sur RHEL/CentOS, dans un terminal Bash, procédez comme suit :

. Arrêtez le service Telegraf :
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. Supprimez l'agent Telegraf :
+
 yum remove telegraf
. Supprimez tous les fichiers de configuration ou de journal qui peuvent être laissés derrière :
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== Mise à niveau de l'agent

Pour mettre à niveau l'agent telegraf, procédez comme suit :

. Arrêtez le service telegraf :
+
....
systemctl stop telegraf (If your operating system is using systemd (CentOS 7+ and RHEL 7+)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. Supprimez l'agent telegraf précédent :
+
 yum remove telegraf
. link:#rhel-and-centos["Installez le nouvel agent"].




=== Ubuntu et Debian

image:Agent_Requirements_Ubuntu.png["Installation de l'agent Ubuntu/Debian"]

.Conditions préalables :
* Les commandes suivantes doivent être disponibles : curl, sudo, ping, sha256sum, openssl, et dmidecode
* Si vous êtes derrière un proxy, suivez les instructions de la section *Configuration de la prise en charge du proxy pour Ubuntu/Debian*.


.Étapes pour installer un agent sur Debian ou Ubuntu :
. Choisissez une clé d'accès d'agent.
. Copiez le bloc de commande à partir de la boîte de dialogue d'installation de l'agent. Vous pouvez cliquer sur l'icône du presse-papiers pour copier rapidement la commande dans le presse-papiers.
. Ouvrez une fenêtre de jeu
. Collez la commande dans la fenêtre Bash et appuyez sur entrée.
. La commande télécharge le programme d'installation de l'agent approprié, l'installe et définit une configuration par défaut. Une fois l'opération terminée, le service agent redémarre. La commande a une clé unique et est valide pendant 24 heures.
. Cliquez sur *Terminer* ou *Continuer*


Une fois l'agent installé, vous pouvez utiliser les commandes suivantes pour démarrer/arrêter le service :

Si votre système d'exploitation utilise systemd :

....
sudo systemctl start telegraf
sudo systemctl stop telegraf
....
Si votre système d'exploitation n'utilise pas le système :

....
sudo service telegraf start
sudo service telegraf stop
....


==== Configuration de la prise en charge de proxy pour Ubuntu/Debian


NOTE: Les étapes ci-dessous présentent les actions nécessaires pour définir les variables d'environnement _http_proxy/https_proxy_. Pour certains environnements proxy, les utilisateurs peuvent également avoir besoin de définir la variable _no_proxy Environment_.

Pour les systèmes résidant derrière un proxy, effectuez les opérations suivantes *ANTÉRIEUR* à l'installation de l'agent Telegraf :

. Définissez les variables d'environnement _https_proxy_ et/ou _http_proxy_ pour l'utilisateur actuel :
+
 export https_proxy=<proxy_server>:<proxy_port>
. Créez /etc/default/telegraf et insérez des définitions pour les variables _https_proxy_ et/ou _http_proxy_ :
+
 https_proxy=<proxy_server>:<proxy_port>




==== Désinstallation de l'agent

Pour désinstaller l'agent sur Ubuntu/Debian, dans un terminal Bash, exécutez les opérations suivantes :

. Arrêtez le service Telegraf :
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. Supprimez l'agent Telegraf :
+
 dpkg -r telegraf
. Supprimez tous les fichiers de configuration ou de journal qui peuvent être laissés derrière :
+
....
rm -rf /etc/telegraf*
rm -rf /var/log/telegraf*
....




==== Mise à niveau de l'agent

Pour mettre à niveau l'agent telegraf, procédez comme suit :

. Arrêtez le service telegraf :
+
....
systemctl stop telegraf (If your operating system is using systemd)
/etc/init.d/telegraf stop (for systems without systemd support)
....
. Supprimez l'agent telegraf précédent :
+
 dpkg -r telegraf
. link:#ubuntu-and-debian["Installez le nouvel agent"].




=== Mac OS

image:Agent_Requirements_Macos.png["Installation de l'agent MacOS"]

.Conditions préalables :
* Les commandes suivantes doivent être disponibles : curl, sudo, openssl et shasum
* Si vous êtes derrière un proxy, suivez les instructions de la section *Configuration du support proxy pour MacOS*.


.Étapes d'installation de l'agent sous MacOS :
. Choisissez une clé d'accès d'agent.
. Copiez le bloc de commande à partir de la boîte de dialogue d'installation de l'agent. Vous pouvez cliquer sur l'icône du presse-papiers pour copier rapidement la commande dans le presse-papiers.
. Ouvrez une fenêtre de jeu
. Collez la commande dans la fenêtre Bash et appuyez sur entrée.
. La commande télécharge le programme d'installation de l'agent approprié, l'installe et définit une configuration par défaut. Une fois l'opération terminée, le service agent redémarre. La commande a une clé unique et est valide pendant 24 heures.
. Si vous avez déjà installé un agent Telegraf à l'aide d'Homebrew, vous êtes invité à le désinstaller. Une fois que l'agent Telegraf installé précédemment est désinstallé, exécutez de nouveau la commande à l'étape 5 ci-dessus.
. Cliquez sur *Terminer* ou *Continuer*


Une fois l'agent installé, vous pouvez utiliser les commandes suivantes pour démarrer/arrêter le service :

....
sudo launchctl start telegraf
sudo launchctl stop telegraf
....


==== Configuration de la prise en charge de proxy pour MacOS


NOTE: Les étapes ci-dessous présentent les actions nécessaires pour définir les variables d'environnement _http_proxy/https_proxy_. Pour certains environnements proxy, les utilisateurs peuvent également avoir besoin de définir la variable _no_proxy Environment_.

Pour les systèmes résidant derrière un proxy, procédez comme suit pour définir les variables d'environnement _https_proxy_ et/ou _http_proxy_ pour l'utilisateur actuel *ANTÉRIEUR* à l'installation de l'agent Telegraf :

 export https_proxy=<proxy_server>:<proxy_port>
*APRÈS* installation de l'agent Telegraf, ajoutez et définissez les variables _https_proxy_ et/ou _http_proxy_ appropriées dans _/applications/telegraf.app/Contents/telegraf.plist_:

....
…
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
   <key>EnvironmentVariables</key>
   <dict>
          <key>https_proxy</key>
          <string><proxy_server>:<proxy_port></string>
   </dict>
   <key>Program</key>
   <string>/Applications/telegraf.app/Contents/MacOS/telegraf</string>
   <key>Label</key>
   <string>telegraf</string>
   <key>ProgramArguments</key>
   <array>
     <string>/Applications/telegraf.app/Contents/MacOS/telegraf</string>
     <string>--config</string>
     <string>/usr/local/etc/telegraf.conf</string>
     <string>--config-directory</string>
     <string>/usr/local/etc/telegraf.d</string>
   </array>
   <key>RunAtLoad</key>
   <true/>
</dict>
</plist>
…
....
Puis, redémarrez Telegraf après avoir chargé les modifications ci-dessus :

....
sudo launchctl stop telegraf
sudo launchctl unload -w /Library/LaunchDaemons/telegraf.plist
sudo launchctl load -w /Library/LaunchDaemons/telegraf.plist
sudo launchctl start telegraf
....


==== Désinstallation de l'agent

Pour désinstaller l'agent sous MacOS, dans un terminal Bash, exécutez les opérations suivantes :

. Arrêtez le service Telegraf :
+
 sudo launchctl stop telegraf
. Désinstallez l'agent telegraf :
+
....
cp /Applications/telegraf.app/scripts/uninstall /tmp
sudo /tmp/uninstall
....
. Supprimez tous les fichiers de configuration ou de journal qui peuvent être laissés derrière :
+
....
rm -rf /usr/local/etc/telegraf*
rm -rf /usr/local/var/log/telegraf.*
....




==== Mise à niveau de l'agent

Pour mettre à niveau l'agent telegraf, procédez comme suit :

. Arrêtez le service telegraf :
+
 sudo launchctl stop telegraf
. Désinstallez l'ancien agent telegraf :
+
....
cp /Applications/telegraf.app/scripts/uninstall /tmp
sudo /tmp/uninstall
....
. link:#macos["Installez le nouvel agent"].




=== Kubernetes

Kubernetes propose deux méthodes de collecte de données :

* Configuration de l'opérateur de surveillance NetApp Kubernetes. Il s'agit de la méthode d'installation recommandée pour Kubernetes.
* Installation traditionnelle d'agent basée sur des scripts


Les instructions d'installation varient en fonction de votre choix.

image:Kubernetes_Operator_Tile_Choices.png["Choix d'installation de Kubernetes"]


NOTE: L'installation de NetApp Kubernetes Monitoring Operator est considérée comme une fonctionnalité de _Preview_ et est donc sujette à modification.

.Conditions préalables :
* Les commandes suivantes doivent être disponibles : curl, sudo, openssl, sha256sum et kubectl
+
Pour obtenir de meilleurs résultats, ajoutez ces commandes au CHEMIN D'ACCÈS.

* les indicateurs d'état kube doivent être installés. Voir ci-dessous pour plus d'informations. Les indicateurs d'état kube sont automatiquement installés avec l'installation basée sur l'opérateur.
* Si vous êtes derrière un proxy, suivez les instructions de la section *Configuration du support proxy pour Kubernetes*.
* Si vous exécutez une variante Kubernetes qui nécessite des contraintes de contexte de sécurité, suivez les instructions de la section *Configuration de l'agent pour collecter des données à partir de Kubernetes*. L'installation basée sur l'opérateur l'installe pour vous.
* Vous devez disposer d'autorisations pour créer des rôles de cluster Kubernetes et des liaisons de rôles.
* L'installation de NetApp Kubernetes Monitoring Operator a été testée et devrait fonctionner avec AWS EKS 1.18, OpenShift 3.11 et Rancher 2.6.




==== La surveillance n'est installée que sur les nœuds Linux

Cloud Insights prend en charge le contrôle des nœuds Kubernetes qui exécutent Linux, en spécifiant un sélecteur de nœud Kubernetes qui recherche les étiquettes Kubernetes suivantes sur les plateformes :

|===
| Plateforme | Étiquette 


| Kubernetes v1.17 et versions supérieures | Kubernetes.io/os = linux 


| Rancher + bétail.io comme plateforme d'orchestration/Kubernetes | bétail.io/os = linux 
|===


==== Installation de l'opérateur de contrôle NetApp Kubernetes

image:Kubernetes_Operator_Agent_Instructions.png["Installation basée sur l'opérateur"]

.Étapes d'installation de l'agent de l'opérateur de surveillance NetApp Kubernetes sur Kubernetes :
. Entrez le nom du cluster et l'espace de noms.
. Une fois ces données saisies, vous pouvez copier l'extrait de code du programme d'installation de l'agent
. Cliquez sur le bouton pour copier ce fragment dans le presse-papiers.
. Collez le fragment dans une fenêtre _bash_ et exécutez-le.
. L'installation se poursuit automatiquement. Une fois la configuration terminée, cliquez sur le bouton _Complete Setup_.




==== Configuration de la prise en charge du proxy pour l'opérateur NetApp Kubernetes Monitoring

Pour configurer un proxy pour l'opérateur de surveillance, procédez comme suit.

Tout d'abord, ouvrez le fichier _agent-monitoring-netapp_ pour le modifier :

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
Dans la section _spec:_ de ce fichier, ajoutez le bloc de code suivant :

....
spec:
  proxy:
    isAuProxyEnabled: <true or false>
    isTelegrafProxyEnabled: <true or false>
    isFluentbitProxyEnabled: <true or false>
    password: <password for proxy, optional>
    port: <port for proxy>
    server: <server for proxy>
    username: <username for proxy, optional>
    noProxy: <comma separated list of IPs or resolvable hostnames that should bypass a proxy>
....


===== À l'aide d'un référentiel docker personnalisé/privé

Si vous utilisez un référentiel docker personnalisé, procédez comme suit :

Découvrez le secret docker :

 kubectl -n netapp-monitoring get secret docker -o yaml
Copiez/collez la valeur de _.dockerconfigjson:_ à partir de la sortie de la commande ci-dessus.

Décodage du secret docker :

 echo <paste from _.dockerconfigjson:_  output above> | base64 -d
Le résultat sera au format json suivant :

....
{ "auths":
  {"docker.<cluster>.cloudinsights.netapp.com" :
    {"username":"<tenant id>",
     "password":"<password which is the CI API key>",
     "auth"    :"<encoded username:password basic auth key. This is internal to docker>"}
  }
}
....
Connectez-vous au référentiel docker :

....
docker login docker.<cluster>.cloudinsights.netapp.com (from step #2) -u <username from step #2>
password: <password from docker secret step above>
....
Tirez l'image de l'opérateur docker depuis Cloud Insights :

 docker pull docker.<cluster>.cloudinsights.netapp.com/netapp-monitoring:<version>
Recherchez le champ <version> à l'aide de la commande suivante :

 kubectl -n netapp-monitoring get deployment monitoring-operator | grep "image:"
Envoyez l'image de docker de l'opérateur à votre référentiel docker privé, local ou d'entreprise, conformément aux règles de votre entreprise.

Téléchargez toutes les dépendances open source dans votre registre Docker privé. Les images Open Source suivantes doivent être téléchargées :

....
docker.io/telegraf:1.19.3
gcr.io/kubebuilder/kube-rbac-proxy:v0.5.0
k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.1.0
....
Si Fluent-bit est activé, téléchargez également :

....
docker.io/fluent-bit:1.7.8
docker.io/kubernetes-event-exporter:0.10
....
Modifiez la demande de modification de l'agent pour qu'elle reflète le nouvel emplacement de docker Repo, désactivez la mise à niveau automatique (si elle est activée).

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
 enableAutoUpgrade: false
....
docker-repo: <docker repo of the enterprise/corp docker repo>
dockerRepoSecret: <optional: name of the docker secret of enterprise/corp docker repo, this secret should be already created on the k8s cluster in the same namespace>
....
Dans la section _spec:_, effectuez les modifications suivantes :

....
spec:
  telegraf:
    - name: ksm
      substitutions:
        - key: k8s.gcr.io
          value: <same as "docker-repo" field above>
....


==== Installation par script

image:Kubernetes_Install_Agent_screen.png["Installation basée sur des scripts"]

.Étapes d'installation de l'agent basé sur des scripts sur Kubernetes :
. Choisissez une clé d'accès d'agent.
. Cliquez sur le bouton *Copy Agent installer Snippet* dans la boîte de dialogue d'installation. Vous pouvez également cliquer sur le bouton _+Reveal Agent installer Snippet_ si vous souhaitez afficher le bloc de commandes.
. Collez la commande dans une fenêtre _bash_.
. Si vous le souhaitez, vous pouvez remplacer l'espace de noms ou fournir le nom du cluster dans le cadre de la commande install en modifiant le bloc de commande afin d'ajouter un ou les deux éléments suivants avant le _ final./$installerName_ final
+
** CLUSTER_NAME=<Cluster Name>
** NAMESPACE=<Namespace>
+
Elle est ici en place dans le bloc de commande :

+
 installerName=cloudinsights-kubernetes.sh ... && CLUSTER_NAME=<cluster_name> NAMESPACE=<new_namespace> sudo -E -H ./$installerName --download --install
+

TIP: _CLUSTER_NAME_ est le nom du cluster Kubernetes à partir de Cloud Insights collecte des metrics, tandis que _NAMESPACE_ est l'espace de nom vers lequel l'agent Telegraf sera déployé. L'espace de nom spécifié sera créé s'il n'existe pas déjà.



. Une fois prêt, exécutez le bloc de commande.
. La commande télécharge le programme d'installation de l'agent approprié, l'installe et définit une configuration par défaut. Si vous n'avez pas explicitement défini le _namespace_, vous serez invité à le saisir. Lorsque vous avez terminé, le script redémarre le service agent. La commande a une clé unique et est valide pendant 24 heures.
. Lorsque vous avez terminé, cliquez sur *Terminer la configuration*.




==== Configuration de la prise en charge du proxy pour Kubernetes - basée sur des scripts


NOTE: Les étapes ci-dessous présentent les actions nécessaires pour définir les variables d'environnement _http_proxy/https_proxy_. Pour certains environnements proxy, les utilisateurs peuvent également avoir besoin de définir la variable _no_proxy Environment_.

Pour les systèmes résidant derrière un proxy, procédez comme suit pour définir les variables d'environnement _https_proxy_ et/ou _http_proxy_ pour l'utilisateur actuel *ANTÉRIEUR* à l'installation de l'agent Telegraf :

 export https_proxy=<proxy_server>:<proxy_port>
*APRÈS* installation de l’agent Telegraf, ajoutez et définissez la ou les variables d’environnement _https_proxy_ et/ou _http_proxy_ appropriées sur la ou les variables d’environnement _telegraf-ds_ demonset et _telegraf-RS_ Replicaet.

 kubectl edit ds telegraf-ds
....
…
       env:
       - name: https_proxy
         value: <proxy_server>:<proxy_port>
       - name: HOSTIP
         valueFrom:
           fieldRef:
             apiVersion: v1
             fieldPath: status.hostIP
…
....
 kubectl edit rs telegraf-rs
....
…
       env:
       - name: https_proxy
         value: <proxy_server>:<proxy_port>
       - name: HOSTIP
         valueFrom:
           fieldRef:
             apiVersion: v1
             fieldPath: status.hostIP
…
....
Redémarrez ensuite Telegraf :

....
kubectl delete pod telegraf-ds-*
kubectl delete pod telegraf-rs-*
....


==== DemonSet, ReplicaSet et arrêt/démarrage de l'agent

Un ensemble de démonstrations et de réplications sera créé sur le cluster Kubernetes afin d'exécuter les agents/pods Telegraf requis. Par défaut, ces agents/modules Telegraf seront planifiés à la fois sur les nœuds maître et non maître.

Pour faciliter l'arrêt et le redémarrage de l'agent, générez le YAML Telegraf DemonSet et ReplicaSet YAML à l'aide des commandes suivantes. Notez que ces commandes utilisent l'espace de noms par défaut « ci-monitoring ». Si vous avez défini votre propre espace de noms, remplacez-le dans ces commandes et fichiers suivants :

Si vous avez défini votre propre espace de noms, remplacez-le dans ces commandes et fichiers suivants :

....
kubectl --namespace ci-monitoring get ds telegraf-ds -o yaml > /tmp/telegraf-ds.yaml
kubectl --namespace ci-monitoring get rs telegraf-rs -o yaml > /tmp/telegraf-rs.yaml
....
Vous pouvez ensuite utiliser les commandes suivantes pour arrêter et démarrer le service Telegraf :

....
kubectl --namespace ci-monitoring delete ds telegraf-ds
kubectl --namespace ci-monitoring delete rs telegraf-rs
....
....
kubectl --namespace ci-monitoring apply -f /tmp/telegraf-ds.yaml
kubectl --namespace ci-monitoring apply -f /tmp/telegraf-rs.yaml
....


==== Configuration de l'agent pour collecter des données à partir de Kubernetes

Remarque : l'espace de noms par défaut pour l'installation basée sur script est _ci-monitoring_. Pour une installation basée sur l'opérateur, l'espace de noms par défaut est _NetApp-monitoring_. Dans les commandes impliquant l'espace de noms, assurez-vous de spécifier l'espace de nom correct pour votre installation.

Les modules dans lesquels les agents exécutent doivent avoir accès aux éléments suivants :

* Chemin d'hôte
* Carte de configuration
* secrets


Ces objets Kubernetes sont automatiquement créés dans le cadre de la commande d'installation de l'agent Kubernetes fournie dans l'interface utilisateur d'Cloud Insights. Certaines versions de Kubernetes, telles qu'OpenShift, proposent un niveau de sécurité supplémentaire qui peut bloquer l'accès à ces composants. La _SecurityContextConstraint_ n'est pas créée dans le cadre de la commande d'installation de l'agent Kubernetes fournie dans l'interface utilisateur Cloud Insights et doit être créée manuellement. Une fois créé, redémarrez le ou les pod(s) Telegraf.

[listing]
----
    apiVersion: v1
    kind: SecurityContextConstraints
    metadata:
      name: telegraf-hostaccess
      creationTimestamp:
      annotations:
        kubernetes.io/description: telegraf-hostaccess allows hostpath volume mounts for restricted SAs.
      labels:
        app: ci-telegraf
    priority: 10
    allowPrivilegedContainer: true
    defaultAddCapabilities: []
    requiredDropCapabilities: []
    allowedCapabilities: []
    allowedFlexVolumes: []
    allowHostDirVolumePlugin: true
    volumes:
    - hostPath
    - configMap
    - secret
    allowHostNetwork: false
    allowHostPorts: false
    allowHostPID: false
    allowHostIPC: false
    seLinuxContext:
      type: MustRunAs
    runAsUser:
      type: RunAsAny
    supplementalGroups:
      type: RunAsAny
    fsGroup:
      type: RunAsAny
    readOnlyRootFilesystem: false
    users:
    - system:serviceaccount:ci-monitoring:monitoring-operator
    groups: []
----


==== Installation du serveur de metrics d'état kube


NOTE: Installation basée sur l'opérateur pour l'installation de metrics kube-State. Ignorez cette section si vous effectuez une installation basée sur l'opérateur.


NOTE: Il est fortement recommandé d'utiliser les metrics kube-state version 2.0 ou ultérieure pour profiter de l'ensemble complet des fonctionnalités, y compris la capacité de lier des volumes persistants Kubernetes (PVS) aux périphériques de stockage back-end. Notez également que avec les metrics d'état kube version 2.0 et supérieure, les étiquettes d'objets Kubernetes ne sont pas exportées par défaut. Pour configurer les metrics kube-State-metrics pour exporter des étiquettes d'objets Kubernetes, vous devez spécifier une liste d'étiquettes de mesure « Autoriser ». Reportez-vous à l'option _--métrique-labels-allowlist_ du link:https://github.com/kubernetes/kube-state-metrics/blob/master/docs/cli-arguments.md["documentation sur les indicateurs d'état kube"].

Procédez comme suit pour installer le serveur de metrics d'état kube (requis si vous effectuez une installation par script) :

.Étapes
. Créez un dossier temporaire (par exemple, _/tmp/kube-State-yaml-files/_) et copiez les fichiers .yaml à partir de https://github.com/kubernetes/kube-state-metrics/tree/master/examples/standard[] dans ce dossier.
. Exécutez la commande suivante pour appliquer les fichiers .yaml nécessaires à l'installation des metrics d'état kube :
+
 kubectl apply -f /tmp/kube-state-yaml-files/




==== Compteurs indicateurs d'état kube

Utilisez les liens suivants pour accéder aux informations des compteurs de metrics d'état kube :

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["Metrics de ConfigMap"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["Indicateurs de démonstration"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["Indicateurs de déploiement"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["Mesures d'entrée"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["Mesures de l'espace de noms"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["Metrics de nœud"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["Métriques de volume persistant"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["Mesures de demande de volume persistant"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["Metrics de pod"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["Metrics de réplicaet"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["Mesures secrètes"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["Metrics de services"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["Metrics StatefulSet"]




==== Désinstallation de l'agent

Notez que ces commandes utilisent l'espace de noms par défaut « ci-monitoring ». Si vous avez défini votre propre espace de noms, remplacez-le dans ces commandes et tous les fichiers suivants.

Pour désinstaller l'agent basé sur des scripts sur Kubernetes, procédez comme suit :

Si l'espace de noms de surveillance est utilisé uniquement pour Telegraf :

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
Si l'espace de noms de surveillance est utilisé à d'autres fins en plus de Telegraf :

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
Pour une installation basée sur l'opérateur, exécutez les commandes suivantes :

....
kubectl delete ns netapp-monitoring
kubectl delete agent agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl delete role agent-leader-election-role
kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader
kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding
....
Si une contrainte de contexte de sécurité a été créée manuellement pour une installation Telegraf basée sur un script :

 kubectl delete scc telegraf-hostaccess


==== Mise à niveau de l'agent

Notez que ces commandes utilisent l'espace de noms par défaut « ci-monitoring ». Si vous avez défini votre propre espace de noms, remplacez-le dans ces commandes et tous les fichiers suivants.

Pour mettre à niveau l'agent telegraf, procédez comme suit :

. Sauvegarder les configurations existantes :
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml


. Désinstallez l'agent (voir ci-dessus pour obtenir des instructions).
. link:#kubernetes["Installez le nouvel agent"].




== Vérification des sommes de contrôle

Le programme d'installation de l'agent Cloud Insights effectue des contrôles d'intégrité, mais certains utilisateurs peuvent effectuer leurs propres vérifications avant d'installer ou d'appliquer des artefacts téléchargés. Pour effectuer une opération de téléchargement uniquement (par opposition au téléchargement et à l'installation par défaut), ces utilisateurs peuvent modifier la commande d'installation de l'agent obtenue à partir de l'interface utilisateur et supprimer l'option "installation" de fin.

Voici la procédure à suivre :

. Copiez l'extrait de code Agent installer comme indiqué.
. Au lieu de coller le fragment dans une fenêtre de commande, collez-le dans un éditeur de texte.
. Supprimez le "--install" (Linux/Mac) ou "-install" (Windows) de la commande.
. Copiez la commande entière à partir de l'éditeur de texte.
. Ensuite, collez-la dans votre fenêtre de commande (dans un répertoire de travail) et exécutez-la.


Non Windows (ces exemples sont pour Kubernetes ; les noms réels de scripts peuvent varier) :

* Téléchargement et installation (par défaut) :
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download –-install
* Téléchargement uniquement :
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download


Windows :

* Téléchargement et installation (par défaut) :
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(&$installerName -download -install)
* Téléchargement uniquement :
+
 !$($installerName=".\cloudinsights-windows.ps1") … -and $(&$installerName -download)


La commande de téléchargement uniquement télécharge tous les artefacts requis de Cloud Insights vers le répertoire de travail. Les artefacts incluent, mais ne se limitent pas aux éléments suivants :

* un script d'installation
* un fichier d'environnement
* Fichiers YAML
* un fichier de somme de contrôle signé (sha256.signé)
* Un fichier PEM (netapp_cert.pem) pour la vérification de la signature


Le script d'installation, le fichier d'environnement et les fichiers YAML peuvent être vérifiés à l'aide d'une inspection visuelle.

Le fichier PEM peut être vérifié en confirmant son empreinte digitale comme suit :

 E5:FB:7B:68:C0:8B:1C:A9:02:70:85:84:C2:74:F8:EF:C7:BE:8A:BC
Plus spécifiquement,

* Non Windows :
+
 openssl x509 -fingerprint -sha1 -noout -inform pem -in netapp_cert.pem
* Windows :
+
 Import-Certificate -Filepath .\netapp_cert.pem -CertStoreLocation Cert:\CurrentUser\Root


Le fichier de somme de contrôle signé peut être vérifié à l'aide du fichier PEM :

* Non Windows :
+
 openssl smime -verify -in sha256.signed -CAfile netapp_cert.pem -purpose any
* Windows (après avoir installé le certificat via Import-Certificate ci-dessus) :
+
 Get-AuthenticodeSignature -FilePath .\sha256.ps1 $result = Get-AuthenticodeSignature -FilePath .\sha256.ps1 $signer = $result.SignerCertificate Add-Type -Assembly System.Security [Security.Cryptography.x509Certificates.X509Certificate2UI]::DisplayCertificate($signer)


Une fois tous les artefacts vérifiés de manière satisfaisante, l'installation de l'agent peut être lancée en exécutant :

Non Windows :

 sudo -E -H ./<installation_script_name> --install
Windows :

 .\cloudinsights-windows.ps1 -install


== Dépannage de l'installation de l'agent

Certaines choses à essayer si vous rencontrez des problèmes lors de la configuration d'un agent :

[cols="2*"]
|===
| Problème : | Essayer : 


| J'ai déjà installé un agent à l'aide de Cloud Insights | Si vous avez déjà installé un agent sur votre hôte/machine virtuelle, il n'est pas nécessaire d'installer l'agent à nouveau. Dans ce cas, il vous suffit de choisir la plate-forme et la clé appropriées dans l'écran installation de l'agent, puis de cliquer sur *Continuer* ou *Terminer*. 


| J'ai déjà un agent installé, mais pas à l'aide du programme d'installation de Cloud Insights | Supprimez l'agent précédent et exécutez l'installation de l'agent Cloud Insights pour vous assurer que les paramètres par défaut du fichier de configuration sont corrects. Lorsque vous avez terminé, cliquez sur *Continuer* ou *Terminer*. 


| Je ne vois pas de lien hypertexte/connexion entre mon volume persistant Kubernetes et le périphérique de stockage back-end correspondant. Mon volume persistant Kubernetes est configuré en utilisant le nom d'hôte du serveur de stockage. | Procédez comme suit pour désinstaller l'agent Telegraf existant, puis réinstaller l'agent Telegraf le plus récent. Vous devez utiliser Telegraf version 2.0 ou ultérieure. 


| Je vois des messages dans les journaux qui ressemblent aux messages suivants : E0901 15:21:39.962145 1 réflecteur.Go:178] k8s.io/kube-State-metrics/interne/magasin/constructeur.Go:352 : échec de la liste *v1.MutatingWebhookConfiguration : le serveur n'a pas pu trouver la ressource demandée E0901 15 178:21.43.168161.0.352.0.0.0.0.1.0.0.0.1.0.0.0.0.0.0.1.0.0.1.0.0.1.0.1.0.0.1.1.0.0.0.1.0.0.1.0.0.0.0. | Ces messages peuvent se produire si vous exécutez des metrics d'état kube version 2.0.0 ou ultérieure avec Kubernetes version 1.17 ou ultérieure. Pour obtenir la version Kubernetes : _kubectl version_ pour obtenir la version kube-state-metrics : _kubectl get deployment/kube-state-metrics -o jsonpath='{..image}'_ pour éviter que ces messages se produisent, les utilisateurs peuvent modifier leur déploiement de metrics kube-state-metrics pour désactiver les baux suivants : _hookingwebconfigurations_. Ressources=certificats,demandes persistantes,configmaps,cronjobs,demonets, déploiements,noeuds finaux,horizontalepodpodscalers,ingresources,details,resuts,undats,depositionsstatees,depositigmats,defiees,resottes,depositionssecuts,defiees,dees,depositionunedats,delimantees,delimantees,deficedats,dees,delimantees,delimantees,delimantees,deficedats,delimantees,deficedats,delimantees,deficedats,deficedats,dees,delimantees,delimantees,dees,delimantees,deficedats,dees,delimantees,delimantees,delimantees,delimantees,de vaillewebconfiguration,v' 


| J'ai installé ou mis à niveau Telegraf sur Kubernetes, mais les modules Telegraf ne démarrent pas. Telegraf ReplicaSet ou DemonSet signale un échec semblable à ce qui suit : erreur de création : pods « telegraf-RS- » interdits » : Impossible de valider une contrainte de contexte de sécurité : [spec.volumes[2] : valeur non valide : « hostPath » : les volumes hostPath ne sont pas autorisés à être utilisés] | Créer une contrainte de contexte de sécurité (reportez-vous à la section Configuration de l'agent pour collecter des données à partir de Kubernetes ci-dessus) si elle n'existe pas déjà. Assurez-vous que l'espace de noms et le compte de service spécifiés pour la contrainte de contexte de sécurité correspondent à l'espace de noms et au compte de service de Telegraf ReplicaSet et DemonSet. Kubectl décrire scc telegraf-hostaccess |grep serviceaccount kubectl -n ci-monitoring --décrire RS telegraf-RS | grep -i "namespace:" kubectl -n surveillance ci décrire RS telegraf-RS | grep -i "compte de service:" kubectl -n ci-monitoring -i-i-s | telegraf-i -i -i 


| Je vois des messages d'erreur de Telegraf ressemblant aux messages suivants, mais Telegraf démarre et s'exécute : oct 11 14:23:41 ip-172-31-39-47 systemd[1] : lancé l'agent serveur piloté par des plug-ins pour signaler des mesures dans InfluxDB. Oct 11 14:23:41 ip-172-31-39-47 telegraf[1827] : heure="2021-10-11T14:23:41Z" level=erreur msg="Impossible de créer le répertoire de cache. /etc/telegraf/.cache/flocon de neige, err: mkdir /etc/telegraf/.ca che: permission refusée. Ignoré\n » func="powflocon.(*defaultLogger).Errorf" file="log.Go:120" oct 11 14:23:41 ip-172-31-39-47 telegraf[1827]: Time="2021-10-11T14:23:41Z" level=error msg="failed to open. Ignoré. Ouvrez /etc/telegraf/.cache/flocon de neige/ocsp_Response_cache.json : aucun fichier ou répertoire\n » func=« gosflocon.(*defaultLogger).Errorf » fichier=« log.Go:120 » oct 11 14:23:41 ip-172-31-39-47 telegraf[1827 23] : 2021-10 T1141114:! Démarrage de Telegraf 1.19.3 | Il s'agit d'un problème connu. Reportez-vous à la section link:https://github.com/influxdata/telegraf/issues/9407["Article GitHub"] pour en savoir plus. Tant que Telegraf est opérationnel, les utilisateurs peuvent ignorer ces messages d'erreur. 


| Sur Kubernetes, mes coffee pad(s) Telegraf ont signalé l'erreur suivante : "erreur lors du traitement des informations de mountstats : échec de l'ouverture du fichier mountstats: /Hostfs/proc/1/mountstats, erreur: Ouvrir /hostfs/proc/1/mountstats: Permission refusée" | Si SELinux est activé et applique, il est probable que le ou les pod(s) Telegraf n'accèdent pas au fichier /proc/1/mountstats sur les nœuds Kubernetes. Pour détendre cette restriction, effectuez l'UNE des opérations suivantes : • pour les installations basées sur des scripts, modifiez le telegraf DS (`kubectl edit ds telegraf-ds`), et remplacer "Privileged: FALSE" par "Privileged: True" • pour une installation basée sur l'opérateur, modifier l'agent (`kubectl edit agent agent-monitoring-netapp`), et remplacer "privileged-mode: false" par "privileged-mode: true" 
|===
Pour plus d'informations, consultez le link:concept_requesting_support.html["Assistance"] ou dans le link:https://docs.netapp.com/us-en/cloudinsights/CloudInsightsDataCollectorSupportMatrix.pdf["Matrice de prise en charge du Data Collector"].
